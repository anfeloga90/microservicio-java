name: CI

on:
  push:
  pull_request:

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Build
      run: |
        chmod +x gradlew
        ./gradlew build
        ls -ltrh

    - name: Run Unit Tests and Check Coverage
      run: |
        ./gradlew test
        ./gradlew build jacocoTestReport
        ls -ltrh
        ls -ltrh build
        echo -----
        cat build/jacocoHtml/index.html

    - name: Check Code Coverage
      run: |
        COVERAGE=$(cat build/jacocoHtml/index.html | grep -oP 'Total</td><td class="bar">[^<]+' | grep -oP '[0-9]+')
        echo COVERAGE=$COVERAGE
        # Extraer el valor actual y total
        valor_actual=$(echo $COVERAGE | cut -d'=' -f2 | cut -d' ' -f1)
        valor_total=$(echo $COVERAGE | cut -d'=' -f2 | cut -d' ' -f2)
        echo valor_actual = $valor_actual
        echo valor_total = $valor_total
        # Calcular el porcentaje
        porcentaje=-$(echo "scale=2; ($valor_actual / $valor_total) * 100" | bc | cut -d'.' -f1)+100
        echo porcentaje = -$porcentaje

        if [ "$porcentaje" -lt 85 ]; then
          echo "Error: La cobertura de cÃ³digo es inferior al 85% (actual: $porcentaje%)."
          exit 1
        fi